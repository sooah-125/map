<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>성서제휴맵_지도</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    :root {
      --bg-color: #f5f5f7;
      --grid-pattern: 
        repeating-linear-gradient(0deg, rgba(0,0,0,0.04) 0px, rgba(0,0,0,0.04) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(90deg, rgba(0,0,0,0.04) 0px, rgba(0,0,0,0.04) 1px, transparent 1px, transparent 20px);
      --text-color: #1d1d1f;
      --text-color-secondary: #6e6e73;
      --apple-blue: #007aff;
      --signup-bg: #000;
      --signup-text: #fff;
      --header-bg: rgba(255, 255, 255, 0.7);
      --border-color: rgba(0, 0, 0, 0.1);
    }
    body.dark-mode {
      --bg-color: #111112;
      --grid-pattern: 
        repeating-linear-gradient(0deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(90deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 1px, transparent 1px, transparent 20px);
      --text-color: #f5f5f7;
      --text-color-secondary: #86868b;
      --signup-bg: #fff;
      --signup-text: #000;
      --header-bg: rgba(28, 28, 30, 0.7);
      --border-color: rgba(255, 255, 255, 0.1);
    }
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif; background-color: var(--bg-color); background-image: var(--grid-pattern); background-size: 20px 20px; transition: background-color 0.3s, color 0.3s; }
    header { position: fixed; top: 0; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; z-index: 1000; box-sizing: border-box; background-color: var(--header-bg); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); border-bottom: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
    .school-name { font-size: 1.5rem; font-weight: 600; color: var(--text-color); text-decoration: none; transition: color 0.3s; }
    .school-name:hover { color: var(--apple-blue); }
    .nav-buttons .nav-list { list-style: none; display: flex; gap: 1rem; margin: 0; padding: 0; align-items: center; }
    .nav-buttons a, .nav-buttons .dropbtn, .nav-buttons button { color: var(--text-color); background: transparent; border: none; font-size: 1rem; font-weight: 500; text-decoration: none; cursor: pointer; white-space: nowrap; transition: color 0.3s ease; }
    .nav-buttons a:hover, .nav-buttons .dropbtn:hover, .nav-buttons button:hover { color: var(--apple-blue); }
    .nav-buttons .signup { background-color: var(--signup-bg); color: var(--signup-text); border-radius: 999px; padding: 0.4rem 1rem; font-weight: 600; }
    li.dropdown { position: relative; padding: 0; } /* 드롭다운 호버 영역 확장 */
    li.dropdown .dropdown-content { display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); min-width: 160px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); z-index: 1001; list-style: none; padding: 0.5rem 0; margin: 0; background-color: var(--header-bg); backdrop-filter: saturate(180%) blur(20px); border: 1px solid var(--border-color); }
    li.dropdown:hover .dropdown-content { display: block; } /* li에 호버 적용 */
    .dropdown-content li a { display: block; padding: 0.7rem 1.2rem; color: var(--text-color); text-decoration: none; font-size: 0.95rem; transition: background-color 0.2s, color 0.2s; }
    .dropdown-content li a:hover { background-color: var(--apple-blue); color: #fff; }
    #hamburger-btn { font-size: 1.5rem; }
    main { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 6rem; height: calc(100vh - 6rem); box-sizing: border-box; }
    .view-toggle-buttons { display: flex; justify-content: flex-end; gap: 0.5rem; width: 90%; max-width: 1500px; margin-bottom: 1rem; }
    .view-toggle-buttons button { border: 1px solid transparent; padding: 0.5rem 1.2rem; font-size: 0.95rem; border-radius: 30px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
    .view-toggle-buttons button:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    body:not(.dark-mode) .view-toggle-buttons button { background: #ffffff; color: #333; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    body:not(.dark-mode) #center-school { background: #e3fddf; }
    body:not(.dark-mode) #show-red-markers { background: #fdd2d2; }
    body:not(.dark-mode) #show-purple-markers { background: #dfd4fc; }
    body:not(.dark-mode) #show-all-markers { background: #cccccc; }
    body.dark-mode .view-toggle-buttons button { background: #2a2a2a; color: #f0f0f0; border-color: #444; }
    #map-container { display: flex; width: 90%; max-width: 1500px; height: 100%; gap: 10px; }
    #map { width: 100%; border-radius: 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); height: 100%; transition: width 0.4s ease; }
    #iframeBox { opacity: 0; transform: translateX(30px); transition: all 0.4s ease; pointer-events: none; width: 0; overflow: hidden; background-color: white; border-radius: 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); position: relative; height: 100%; }
    body.dark-mode #iframeBox { background-color: #1c1c1e; }
    #iframeBox iframe { width: 100%; height: 100%; border: none; display: none; }
    #iframeBox .close-btn { position: absolute; top: 10px; right: 10px; background: transparent; border: none; font-size: 20px; cursor: pointer; z-index: 10; color: #888; }
    body.dark-mode #iframeBox .close-btn { color: #aaa; }
    #map-container.half-map #map { width: 50%; }
    #map-container.half-map #iframeBox { width: 50%; opacity: 1; transform: translateX(0); pointer-events: auto; }
    .custom-marker { background-color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.4); border: 2px solid white; transition: transform 0.2s; }
    .marker-red { background-color: #ff3b30; }
    .marker-purple { background-color: #af52de; }
    .marker-yellow { background-color: #ffcc00; }
    .marker-gray { background-color: #8e8e93; }
    .marker-green { background-color: #34c759; }
    .custom-marker i { color: white; font-size: 14px; }
    .leaflet-tooltip.custom-tooltip { background-color: rgba(255, 255, 255, 0.85); border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); color: #333; font-weight: 600; padding: 4px 8px; white-space: nowrap; }
    body.dark-mode .leaflet-tooltip.custom-tooltip { background-color: rgba(40, 40, 40, 0.85); border-color: #555; color: #eee; }
    #side-nav { position: fixed; top: 0; right: -300px; width: 300px; height: 100vh; background-color: var(--header-bg); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); box-shadow: -10px 0 30px rgba(0,0,0,0.3); border-left: 1px solid var(--border-color); transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); z-index: 1500; padding: 2rem; box-sizing: border-box; }
    #side-nav.open { right: 0; }
    #side-nav .close-btn { position: absolute; top: 1rem; right: 1.5rem; background: transparent; border: none; font-size: 2rem; color: var(--text-color); cursor: pointer; }
    #side-nav nav { margin-top: 3rem; }
    #side-nav nav ul { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 1.5rem; }
    #side-nav nav ul li a, #side-nav nav ul li button { background: none; border: none; color: var(--text-color); font-size: 1.2rem; font-weight: 500; cursor: pointer; text-align: left; width: 100%; padding: 0; display: block; text-decoration: none; transition: color 0.3s; }
    #side-nav nav ul li a:hover, #side-nav nav ul li button:hover { color: var(--apple-blue); }
    #side-nav nav ul li button { display: flex; justify-content: space-between; align-items: center; }
    #side-nav nav ul li ul { display: none; flex-direction: column; padding-left: 1.5rem; margin-top: 1.2rem; gap: 1rem; list-style-type: none; }
    #side-nav nav ul li ul li a { font-size: 1rem; font-weight: 400; color: var(--text-color-secondary); }
    #overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 1200; display: none; }
    #overlay.active { display: block; }
    .theme-switcher { display: flex; align-items: center; }
    #theme-toggle { display: none; }
    #theme-toggle + label { position: relative; display: flex; align-items: center; width: 50px; height: 28px; background-color: #ccc; border-radius: 999px; cursor: pointer; transition: background-color 0.3s; }
    #theme-toggle + label::before { content: ''; position: absolute; left: 3px; width: 22px; height: 22px; background-color: white; border-radius: 50%; transition: transform 0.3s; }
    #theme-toggle + label .icon { position: absolute; font-size: 14px; transition: opacity 0.3s; user-select: none; }
    #theme-toggle + label .sun-icon { right: 5px; opacity: 1; }
    #theme-toggle + label .moon-icon { left: 5px; opacity: 0; }
    #theme-toggle:checked + label { background-color: var(--apple-blue); }
    #theme-toggle:checked + label::before { transform: translateX(22px); }
    #theme-toggle:checked + label .sun-icon { opacity: 0; }
    #theme-toggle:checked + label .moon-icon { opacity: 1; }
    @media (max-width: 768px) { #map-container { flex-direction: column; } #map-container.half-map #map, #map-container.half-map #iframeBox { width: 100%; } #map-container.half-map #map { height: 40%; } #map-container.half-map #iframeBox { height: 60%; } }
  </style>
</head>
<body>
  <script src="./chatbot.js"></script> 
  <div id="overlay"></div>

  <header>
    <a href="index.html" class="school-name">KBU Partner Map</a>
    <nav class="nav-buttons">
      <ul class="nav-list">
        <li><a href="index.html">HOME</a></li>
        <li><a href="map.html">지도</a></li>
        <li class="dropdown">
          <a class="dropbtn">리스트</a>
          <ul class="dropdown-content">
            <li><a href="list_restourant.html">식당 제휴</a></li>
            <li><a href="list_leisure.html">여가 제휴</a></li>
          </ul>
        </li>
        <li><a href="external.html">외부업체</a></li>
        <li class="theme-switcher">
          <input type="checkbox" id="theme-toggle">
          <label for="theme-toggle">
            <span class="icon sun-icon">☀️</span>
            <span class="icon moon-icon">🌙</span>
          </label>
        </li>
        <li><button id="hamburger-btn">☰</button></li>
        <li><a href="login.html" class="signup">Sign Up</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <div class="view-toggle-buttons">
      <button id="center-school">학교</button>
      <button id="show-red-markers">식당</button>
      <button id="show-purple-markers">여가</button>
      <button id="show-all-markers">전체</button>
      <button id="expand-view">자세히</button>
      <button id="collapse-view">간단히</button>
    </div>
    <div id="map-container">
      <div id="iframeBox">
        <button class="close-btn" onclick="closeIframe()">✖</button>
        <iframe id="infoFrame" src=""></iframe>
      </div>
      <div id="map"></div>
    </div>
  </main>

  <aside id="side-nav" aria-label="사이드 내비게이션">
    <button class="close-btn" aria-label="사이드 내비 닫기">&times;</button>
    <nav>
      <ul>
        <li><a href="map.html">지도로 보기</a></li>
        <li>
          <button id="side-list-btn" aria-expanded="false">리스트로 보기 ⏷</button>
          <ul id="side-list-submenu" style="display: none;">
            <li><a href="list_restourant.html">식당 제휴</a></li>
            <li><a href="list_leisure.html">여가 제휴</a></li>
            <li><a href="external.html">외부 업체</a></li>
          </ul>
        </li>
        
        <li><a href="sitemap.html">사이트맵</a></li>
        <li><a href="ask.html">문의</a></li>
      </ul>
    </nav>
  </aside>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="data.js"></script>
  
  <script>
    // --- 1. 초기 설정 및 변수 선언 ---
    let lastCenterPixel = null, currentRoute = null, selectedMarker = null;
    const allMarkers = [];

    const map = L.map('map', { attributionControl: false, zoomControl: false }).setView([37.6487780, 127.0643529], 16);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const simpleTile = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 });
    const darkTile = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 });
    const detailedTile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
    let currentTile = simpleTile;
    simpleTile.addTo(map);

    const markers = L.markerClusterGroup({
        spiderfyOnMaxZoom: true, showCoverageOnHover: false, zoomToBoundsOnClick: true,
        iconCreateFunction: cluster => L.divIcon({ html: `<div><span>${cluster.getChildCount()}</span></div>`, className: 'marker-cluster marker-cluster-small', iconSize: new L.Point(40, 40) })
    });
    map.addLayer(markers);
    
    // --- 2. Leaflet 마커 생성 및 관리 ---
    function createCustomIcon(colorClass, iconClass) {
        return L.divIcon({ className: `custom-marker ${colorClass}`, html: `<i class="${iconClass}"></i>`, iconSize: [30, 30], iconAnchor: [15, 15] });
    }

    function createMarker(store, isBase = false) {
        const { coords, name, category } = store;
        const [lat, lng] = coords;

        let markerIcon;
        if (isBase) {
            const iconClass = name.includes('역') ? 'fa-solid fa-train-subway' : 'fa-solid fa-school';
            markerIcon = createCustomIcon('marker-green', iconClass);
        } else {
            let colorClass, iconClass;
            switch (category) {
                case '식당': colorClass = 'marker-red'; iconClass = 'fa-solid fa-utensils'; break;
                case '여가': colorClass = 'marker-purple'; iconClass = 'fa-solid fa-star'; break;
                case '외부': colorClass = 'marker-yellow'; iconClass = 'fa-solid fa-star'; break;
                default: colorClass = 'marker-gray'; iconClass = 'fa-solid fa-store'; break;
            }
            markerIcon = createCustomIcon(colorClass, iconClass);
        }

        const marker = L.marker([lat, lng], { icon: markerIcon });
        
        // 툴팁(이름표)을 마커에 바인딩. 마우스를 올려야 보이도록 permanent: false로 설정
        marker.bindTooltip(name, { permanent: false, direction: 'top', offset: [0, -15], className: 'custom-tooltip' });
        
        if (!isBase) {
            marker.on('click', () => {
                if (selectedMarker) selectedMarker.setZIndexOffset(0);
                marker.setZIndexOffset(1000);
                selectedMarker = marker;

                lastCenterPixel = map.latLngToContainerPoint(map.getCenter());
                openIframe(`info.html?name=${encodeURIComponent(name)}`);
                
                // 클릭 시 툴팁을 닫고, 경로/거리 팝업을 띄우는 로직으로 변경
                if (marker.isTooltipOpen()) marker.closeTooltip();
                drawRealRouteToBase([lat, lng], marker); // marker를 전달

                setTimeout(() => {
                    const isHalfMap = document.getElementById('map-container').classList.contains('half-map');
                    let offsetX = 0;
                    if (isHalfMap && window.innerWidth > 768) offsetX = map.getSize().x * -0.25;
                    const point = map.latLngToContainerPoint([lat, lng]);
                    map.panTo(map.containerPointToLatLng(L.point(point.x - offsetX, point.y)), { animate: true });
                }, 400);
            });
        }
        marker.storeInfo = store;
        return marker;
    }

    // --- 3. UI 이벤트 리스너 ---
    document.getElementById("expand-view")?.addEventListener("click", () => { if (currentTile !== detailedTile) { map.removeLayer(currentTile); detailedTile.addTo(map); currentTile = detailedTile; } });
    document.getElementById("collapse-view")?.addEventListener("click", () => { const isDarkMode = document.body.classList.contains('dark-mode'); const targetTile = isDarkMode ? darkTile : simpleTile; if (currentTile !== targetTile) { map.removeLayer(currentTile); targetTile.addTo(map); currentTile = targetTile; } });
    document.getElementById("center-school")?.addEventListener("click", () => map.setView([37.6487780, 127.0643529], 17));
    document.getElementById("show-all-markers")?.addEventListener("click", () => { markers.clearLayers(); markers.addLayers(allMarkers); });
    document.getElementById("show-red-markers")?.addEventListener("click", () => { markers.clearLayers(); markers.addLayers(allMarkers.filter(m => m.storeInfo.category === '식당')); });
    document.getElementById("show-purple-markers")?.addEventListener("click", () => { markers.clearLayers(); markers.addLayers(allMarkers.filter(m => m.storeInfo.category === '여가')); });

    // --- 4. Iframe 및 경로 그리기 함수 ---
    function openIframe(url) { document.getElementById('map-container').classList.add('half-map'); const infoFrame = document.getElementById('infoFrame'); infoFrame.src = url; infoFrame.style.display = "block"; }
    function closeIframe() { if (selectedMarker) { selectedMarker.setZIndexOffset(0); selectedMarker = null; } map.closePopup(); document.getElementById('map-container').classList.remove('half-map'); const infoFrame = document.getElementById('infoFrame'); infoFrame.src = ''; infoFrame.style.display = "none"; if (currentRoute) map.removeLayer(currentRoute); setTimeout(() => { if (lastCenterPixel) map.panTo(map.containerPointToLatLng(lastCenterPixel), { animate: true }); }, 400); }
    
    function drawRealRouteToBase(destinationLatLng, clickedMarker) {
        if (currentRoute) map.removeLayer(currentRoute);
        map.closePopup(); // 기존 팝업 닫기
        
        fetch("https://api.openrouteservice.org/v2/directions/foot-walking/geojson", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "5b3ce3597851110001cf62481a5f204986714b06a851c1794e6ec7db" },
            body: JSON.stringify({ coordinates: [[127.0643529, 37.6487780], [destinationLatLng[1], destinationLatLng[0]]] })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.features) return;

            currentRoute = L.geoJSON(data, { style: { color: '#007aff', weight: 5, opacity: 0.7, dashArray: '8, 6' } }).addTo(map);

            const summary = data.features[0].properties.summary;
            const distanceKm = (summary.distance / 1000).toFixed(2);
            const durationMin = Math.ceil(summary.duration / 60);
            const content = `<div style="text-align: left; font-weight: bold; padding-left: 5px;">${distanceKm}km<br>${durationMin}분</div>`;

            const popup = L.popup({ offset: [0, -15], closeButton: false })
                .setLatLng(destinationLatLng)
                .setContent(content)
                .openOn(map);

            // 팝업이 닫힐 때, 툴팁 기능을 다시 활성화
            popup.on('remove', () => {
                if (!clickedMarker.isTooltipOpen()) {
                    clickedMarker.bindTooltip(clickedMarker.storeInfo.name, { permanent: false, direction: 'top', offset: [0, -15], className: 'custom-tooltip' });
                }
            });
        })
        .catch(err => console.error("경로 오류:", err));
    }
    
    // --- 5. 테마 및 사이드바 제어 ---
    const themeToggle = document.getElementById("theme-toggle"); themeToggle.addEventListener("change", () => { document.body.classList.toggle("dark-mode"); const isDarkMode = document.body.classList.contains('dark-mode'); const targetTile = isDarkMode ? darkTile : simpleTile; if (currentTile !== detailedTile) { map.removeLayer(currentTile); targetTile.addTo(map); currentTile = targetTile; } });
    const hamburgerBtn = document.getElementById("hamburger-btn"), sideNav = document.getElementById("side-nav"), overlay = document.getElementById("overlay"), closeBtn = document.querySelector("#side-nav .close-btn"); hamburgerBtn?.addEventListener("click", () => { sideNav.classList.add("open"); overlay.classList.add("active"); }); closeBtn?.addEventListener("click", () => { sideNav.classList.remove("open"); overlay.classList.remove("active"); }); overlay?.addEventListener("click", () => { sideNav.classList.remove("open"); overlay.classList.remove("active"); });
    const sideListBtn = document.getElementById("side-list-btn"), sideListSubmenu = document.getElementById("side-list-submenu"); sideListBtn?.addEventListener("click", () => { const isOpen = sideListSubmenu.style.display === "block"; sideListSubmenu.style.display = isOpen ? "none" : "block"; sideListBtn.innerHTML = isOpen ? "리스트로 보기 ⏷" : "리스트로 보기 ⏶"; });

    // --- 6. Firebase 인증 (모듈 방식 제거, 이전 방식으로 복원) ---
    const firebaseConfig = { apiKey: "AIzaSyD-itP2Il2kZYzm-4BXL5wXXphp5gnTN3U", authDomain: "web-programing-6218e.firebaseapp.com", projectId: "web-programing-6218e" };
    firebase.initializeApp(firebaseConfig);
    firebase.auth().onAuthStateChanged(user => {
        const signupLink = document.querySelector("a.signup");
        if (!signupLink) return;
        if (user) {
            signupLink.textContent = "Log out";
            signupLink.href = "#";
            signupLink.onclick = (e) => { e.preventDefault(); firebase.auth().signOut().then(() => location.reload()); };
        } else {
            signupLink.textContent = "Sign Up";
            signupLink.href = "login.html";
            signupLink.onclick = null;
            if (["map.html"].includes(window.location.pathname.split("/").pop())) {
                alert("로그인이 필요합니다.");
                window.location.href = "login.html";
            }
        }
    });

    // --- 7. 데이터 로딩 및 초기화 ---
    document.addEventListener('DOMContentLoaded', () => {
        const baseStores = [
            { name: '한국성서대학교', coords: [37.6487780, 127.0643529] },
            { name: '노원역', coords: [37.6562678, 127.0630304] },
            { name: '중계역', coords: [37.6448907, 127.0642467] }
        ];
        baseStores.forEach(store => {
            const baseMarker = createMarker(store, true);
            baseMarker.options.isBaseMarker = true;
            baseMarker.addTo(map);
        });

        if (typeof storeData !== 'undefined') {
            storeData.forEach(store => {
                if (store.coords && store.coords[0] !== 0) {
                    allMarkers.push(createMarker(store));
                }
            });
        }
        markers.addLayers(allMarkers);

        const urlParams = new URLSearchParams(window.location.search);
        const placeToFocus = decodeURIComponent(urlParams.get('place') || '');
        if (placeToFocus) {
            setTimeout(() => {
                const found = allMarkers.find(m => m.storeInfo.name === placeToFocus);
                if (found) {
                    markers.zoomToShowLayer(found, () => {
                        map.setView(found.getLatLng(), 18);
                        found.fire('click');
                    });
                }
            }, 500);
        }
    });
  </script>






</body>
</html>
